---
import LoadingOverlay from "../components/loading_overlay.astro";
import ProjectTile from "../components/project_tile.astro";
import LogoTile from "../components/logo_tile.astro";
import ThemeBootstrap from "../components/theme_bootstrap.astro";
import "../styles/global.css";

const projects = [
    {
        image: "/images/img_1.jpg",
        alt: "Canopée housing extension",
        title: "Canopée",
        year: "2024",
        location: "Turin, IT",
        description:
            "Three linked volumes around a productive greenhouse, balancing structural performance, climate response, and social functionality.",
        link: "/canopee"
    },
    {
        image: "/images/img_2.jpg",
        alt: "Þoka public square concept",
        title: "þoka",
        year: "2025",
        location: "Oslo, NO",
        description:
            "Conceptual square between the national museum and library, mediating cultural anchors with civic landscape gestures.",
        link: "/thoka"
    },
    {
        image: "/images/img_3.jpg",
        alt: "Resonance winery and cultural center",
        title: "Resonance",
        year: "2025",
        location: "Clavesana, IT",
        description:
            "Transforms a derelict monastery into a working winery and reimagines a nearby chapel as a multicultural center organized around seasonality.",
        link: "/resonance"
    },
    {
        image: "/images/img_4.jpg",
        alt: "Kinetra dual-helix academic tower",
        title: "Kinetra",
        year: "2024",
        location: "Seestadt, AT",
        description:
            "Off-centre dual-helix structure hosting university programs and housing above a commercial base as a local nexus.",
        link: "/kinetra"
    },
    {
        image: "/images/img_5.jpg",
        alt: "Photography portfolio link",
        title: "Photography",
        description: "Browse photography projects and studies.",
        link: "/photography"
    },
    {
        image: "/images/img_6.jpg",
        alt: "Ferska adaptive reuse",
        title: "Ferska",
        year: "2024",
        location: "Cerdanyola del Vallès, ES",
        description:
            "Renovation of a steel factory into a café, bike shop, and trailhead workshop for hikers and cyclists.",
        link: "/ferska"
    },
    {
        image: "/images/img_7.jpg",
        alt: "Upcoming project slot",
        title: "Upcoming",
        year: "",
        location: "",
        description: "Reserved for next commission."
    },
    {
        image: "/images/img_8.jpg",
        alt: "Upcoming project slot",
        title: "Upcoming",
        year: "",
        location: "",
        description: "Reserved for next commission."
    }
];
---

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>lnp.</title>
    <ThemeBootstrap />
</head>

<LoadingOverlay />

<div class="grid">
    {projects.slice(0, 4).map((p, idx) => (
            <ProjectTile {...p} index={idx} />
    ))}

    <LogoTile
            title="lnp."
            slogan="contemporary ataraxia."
            index={4}
    />

    {projects.slice(4).map((p, idx) => (
            <ProjectTile {...p} index={idx + 5} />
    ))}
</div>

<!-- Project details side-sheet / bottom sheet -->
<div id="project-panel" class="project-panel" aria-hidden="true">
    <div class="project-panel-backdrop"></div>

    <aside class="project-panel-sheet" role="dialog" aria-modal="true">
        <button
                class="project-panel-close"
                type="button"
                aria-label="Close project details"
        >
            ×
        </button>

        <div class="project-panel-image-wrap">
            <img id="project-panel-image" src="" alt="" />
        </div>

        <div class="project-panel-body">
            <h2><a id="project-panel-title" href=""></a></h2>
            <p class="panel-description" id="project-panel-description"></p>
            <p class="panel-meta-inline" id="project-panel-meta"></p>
        </div>
    </aside>
</div>


<script>
    // Theme toggle
    (function () {
        const root = document.documentElement;
        const btn = document.querySelector(".mode-toggle");
        const icon = btn?.querySelector(".mode-icon");
        const STORAGE_KEY = "portfolio-theme";
        const logoTile = document.querySelector(".logo-tile");

        const LIGHT_BG = "#f7f7f7";
        const DARK_BG = "#1f1f1f";

        const lerp = (a, b, t) => a + (b - a) * t;
        const hexToRgb = (hex) => {
            const val = hex.replace("#", "");
            return {
                r: parseInt(val.substring(0, 2), 16),
                g: parseInt(val.substring(2, 4), 16),
                b: parseInt(val.substring(4, 6), 16)
            };
        };
        const rgbStringToHex = (rgbString) => {
            const match = rgbString.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
            if (!match) return "#000000";
            const [r, g, b] = match.slice(1, 4).map((v) => parseInt(v, 10));
            const toHex = (n) => n.toString(16).padStart(2, "0");
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        };
        const animateColour = (el, startHex, endHex, duration = 700) => {
            if (!el) return;
            const start = hexToRgb(startHex);
            const end = hexToRgb(endHex);
            const startTime = performance.now();
            el.style.backgroundColor = startHex;

            const frame = (time) => {
                const t = Math.min((time - startTime) / duration, 1);
                const r = Math.round(lerp(start.r, end.r, t));
                const g = Math.round(lerp(start.g, end.g, t));
                const b = Math.round(lerp(start.b, end.b, t));
                el.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                if (t < 1) requestAnimationFrame(frame);
            };
            requestAnimationFrame(frame);
        };

        const applyTheme = (theme, animate = false) => {
            if (!root) return;
            if (theme === "dark") {
                root.setAttribute("data-theme", "dark");
            } else {
                root.removeAttribute("data-theme");
            }
            if (icon) {
                icon.textContent = theme === "dark" ? "☾" : "☀";
            }
            if (logoTile && animate) {
                logoTile.classList.add("theme-shift");
                setTimeout(() => {
                    logoTile.classList.remove("theme-shift");
                }, 500);
            }
        };

        const stored =
            typeof window !== "undefined"
                ? window.localStorage.getItem(STORAGE_KEY)
                : null;
        applyTheme(stored === "dark" ? "dark" : "light");

        if (btn) {
            btn.addEventListener("click", () => {
                const isDark = root.getAttribute("data-theme") === "dark";
                const next = isDark ? "light" : "dark";
                const inner = logoTile?.querySelector(".inner");
                const fadeTargets = logoTile
                    ? Array.from(logoTile.querySelectorAll(".inner, .mode-toggle, .logo-socials, .logo-contact"))
                    : [];
                const FADE_MS = 250;
                const currentBg =
                    (logoTile && rgbStringToHex(getComputedStyle(logoTile).backgroundColor)) ||
                    (isDark ? DARK_BG : LIGHT_BG);
                const targetBg = next === "dark" ? DARK_BG : LIGHT_BG;
                fadeTargets.forEach((el) => {
                    el.style.opacity = "0";
                });
                setTimeout(() => {
                    applyTheme(next, true);
                    animateColour(logoTile, currentBg, targetBg);
                    fadeTargets.forEach((el) => {
                        el.style.opacity = "1";
                    });
                }, FADE_MS);
                if (typeof window !== "undefined") {
                    window.localStorage.setItem(STORAGE_KEY, next);
                }
            });
        }
    })();

    // Project side-sheet / bottom sheet
    (function () {
        const panel = document.getElementById("project-panel");
        if (!panel) return;

        const backdrop = panel.querySelector(".project-panel-backdrop");
        const closeBtn = panel.querySelector(".project-panel-close");

        const imgEl = document.getElementById("project-panel-image");
        const titleLink = document.getElementById("project-panel-title");
        const metaEl = document.getElementById("project-panel-meta");
        const descEl = document.getElementById("project-panel-description");

        const openPanel = (tile) => {
            if (!tile) return;
            const title = tile.dataset.projectTitle || "";
            const year = tile.dataset.projectYear || "";
            const location = tile.dataset.projectLocation || "";
            const description = tile.dataset.projectDescription || "";
            const image = tile.dataset.projectImage || "";
            const link = tile.dataset.link || "";

            if (imgEl) {
                imgEl.src = image;
                imgEl.alt = title || "Project image";
            }
            if (titleLink) {
                titleLink.textContent = title;
                titleLink.href = link || "#";
            }
            const metaParts = [year, location].filter(Boolean);
            if (link === "/photography") {
                metaParts.length = 0;
            }
            if (metaEl) metaEl.textContent = metaParts.join(" · ");
            if (descEl) descEl.textContent = description;

            panel.classList.add("is-open");
            panel.setAttribute("aria-hidden", "false");
        };

        const closePanel = () => {
            panel.classList.remove("is-open");
            panel.setAttribute("aria-hidden", "true");
        };

        document.addEventListener("click", (event) => {
            const target = event.target;
            if (!target.closest) return;
            const tile = target.closest(".project-tile");
            if (tile) {
                event.preventDefault();
                openPanel(tile);
            }
        });

        [backdrop, closeBtn].forEach((el) => {
            if (!el) return;
            el.addEventListener("click", (event) => {
                event.preventDefault();
                closePanel();
            });
        });

        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                closePanel();
            }
        });
    })();
</script>
